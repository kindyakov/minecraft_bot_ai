# 🤖 Minecraft Bot

## 📂 Архитектура проекта

```
minecraft_bot_ai/
├── 📁 src/                                 ← ✅ Основная логика приложения
│   ├── 📁 core/                            ← ✅ Базовые системные компоненты
│   │   ├── bot.js                          ← ✅ MinecraftBot - управление ботом
│   │   ├── fsm.js                          ← ✅ BotStateMachine - управление переходами состояний + стек состояний
│   │   └── survival.js                     ← 🆕 SurvivalSystem - фоновый мониторинг жизненно важных показателей
│   │
│   ├── 📁 modules/                         ← ✅ Основные функциональные модули
│   │   ├── 📁 connection/                  ← ✅ Управление подключением к серверу
│   │   │   └── index.js                    ← ✅ initConnection - инициализация плагинов и CommandHandler
│   │   │
│   │   ├── 📁 commands/                    ← ✅ Команды от игроков (приоритет 10)
│   │   │   ├── BaseCommand.js              ← ✅ Абстрактный класс для команд
│   │   │   ├── CommandHandler.js           ← ✅ Парсер команд и диспетчер выполнения
│   │   │   ├── index.commands.js           ← ✅ Реестр доступных команд
│   │   │   ├── help.js                     ← ✅ Справка по доступным командам
│   │   │   └── ...
│   │   │
│   │   ├── 📁 states/                      ← ✅ FSM состояния бота с системой приоритетов
│   │   │   ├── BaseState.js                ← ✅ Абстрактный класс с freeze/resume методами
│   │   │   ├── IdleState.js                ← ✅ Состояние ожидания (приоритет 1) + обработка стека задач
│   │   │   ├── FollowState.js              ← ✅ Неприкосновенное состояние (приоритет 9) + защита без смены состояния
│   │   │   ├── CombatState.js              ← ✅ Боевое состояние (приоритет 6) + автовозврат
│   │   │   ├── MineState.js                ← 🆕 Состояние копания (приоритет 7) + pause/resume
│   │   │   ├── FarmState.js                ← 🆕 Состояние фармерства (приоритет 7) + pause/resume
│   │   │   ├── BuildState.js               ← 🆕 Состояние строительства (приоритет 7) + pause/resume
│   │   │   └── index.states.js             ← ✅ Реестр доступных состояний для FSM
│   │   │
│   │   ├── 📁 tasks/                       ← ✅ Стек задач бота с приоритетами
│   │   │   ├── TaskManager.js              ← ✅ Управление стеком задач (критические, высокие, средние)
│   │   │   ├── BaseTask.js                 ← ✅ Абстрактный класс для задач
│   │   │   ├── FindShelterTask.js          ← ✅ Задача для
│   │   │   ├── NeedFoodTask.js             ← ✅ Задача для поиска еды
│   │   │   ├── RepairArmorTask.js          ← ✅ Задача для починки брони
│   │   │   └── index.tasks.js              ← ✅ Реестр доступных задач
│   │   │
│   │   └── 📁 plugins/                     ← ✅ Mineflayer плагины и инициализация
│   │       ├── armorManager.js
│   │       ├── pathfinder.js
│   │       ├── viewer.js
│   │       ├── webInventory.js
│   │       ├── goals.js
│   │       ├── ...
│   │       └── index.plugins.js            ← ✅ Загрузка pathfinder, armor-manager, auto-eat, web-inventory, viewer
│   │
│   └── 📁 config/                          ← ✅ Конфигурационные файлы
│   │   ├── priorities.js                   ← 🆕 Система числовых приоритетов (10-1)
│   │   ├── commands.js
│   │   ├── config.js
│   │   └── logger.js                       ← ✅ BotLogger класс с методами для разных типов логирования
│   │
│   └── 📁 utils/
│   │    ├── 📁 general/
│   │    └── 📁 minecraft/
│   │        ├── AntiStuck.js
│   │        └── botUtils.js
│   │
├── 📁 config/                              ← ✅ Внешние конфигурации
│   └── .env.example                        ← ✅ Шаблон переменных окружения
│
├── 📁 docs/
│   ├── 📄 minecraft_bot.md                    ← ✅ Подробная архитектурная документация
│   └── 📄 README.md                           ← ✅ Документация проекта
│
├── 📄 .gitignore                          ← ✅ Git исключения (logs, node_modules, .env)
├── 📄 nodemon.json                        ← ✅ Конфигурация для разработки с hot reload
├── 📄 package.json                        ← ✅ Зависимости и скрипты проекта
└── 📄 package-lock.json                   ← ✅ Lockfile зависимостей
```

## ⚙️ Основные зависимости

- `mineflayer` — основной API для Minecraft
- `mineflayer-pathfinder` — навигация
- `mineflayer-collectblock` — сбор блоков
- `minecraft-data` — доступ к данным о мире
- `mineflayer-armor-manager` - автоматически экипировать более качественную броню
- `mineflayer-web-inventory` - просмотр инвенторя в браузере
- `mineflayer-auto-eat` - автоматическая еда
- `dotenv` — конфиги
- `winston` — логирование
- `axios` — вызовы внешних API (AI)
- `ajv` — валидация JSON схем
- `prettier` — стиль кода

## 🔑 Конфиги (`.env.example`)

```
MINECRAFT_HOST=localhost
MINECRAFT_PORT=22222
MINECRAFT_USERNAME=bot
MINECRAFT_VERSION=1.20.1

MINECRAFT_VIEWER_PORT=9000
MINECRAFT_WEB_INVENTORY_PORT=9001

AI_PROVIDER=openai
AI_MODEL=gpt-4o-mini
AI_API_KEY=sk-...
AI_TIMEOUT_MS=800
AI_MAX_TOKENS=300

NODE_ENV=development
```

## 🚦 Жизненный цикл бота

1. **Запуск:**
   - Чтение конфигов
   - Создание экземпляра MinecraftBot
   - Инициализация SurvivalSystem
   - Подключение к серверу

2. **Инициализация:**
   - Регистрация обработчиков событий
   - Запуск FSM (состояние IDLE)
   - Запуск SurvivalSystem в фоновом режиме
   - Инициализация TaskManager для стека задач

3. **Работа:**
   - FSM обрабатывает команды по системе приоритетов (10-1)
   - SurvivalSystem мониторит здоровье, голод, броню, прочность
   - Критические задачи прерывают состояния ≤7 уровня
   - AI принимает решения в IdleState или по команде

4. **Отключение/реконнект:**
   - При разрыве соединения запускается реконнект
   - Состояния freeze/resume сохраняют контекст
   - SurvivalSystem восстанавливает мониторинг

## 🔔 Событийная модель

- Mineflayer события: `spawn`, `death`, `chat`, `health`, `entityHurt`, `blockUpdate`
- Кастомные события:
  - `state:changed` — смена FSM состояния
  - `state:paused` — состояние приостановлено критической задачей
  - `state:resumed` — состояние возобновлено после выполнения критической задачи
  - `task:critical` — критическая задача добавлена в стек
  - `task:completed` — задача завершена
  - `survival:alert` — критическое состояние здоровья/голода
  - `ai:decision` — новое решение AI

Общение между модулями — через `EventEmitter`.

## 🎯 Система приоритетов (новая архитектура)

```
Приоритет | Компонент                    | Описание
----------|------------------------------|----------------------------------
10        | Команды игрока               | Абсолютный приоритет, прерывают всё
9         | FollowState                  | Неприкосновенное состояние
8         | Критические задачи           | Здоровье < 3, отсутствие еды
7         | MineState/FarmState/BuildState| Прерывается критическими
6         | CombatState                  | Автоматические переходы
5         | Обычные задачи из стека      | Оптимизация, улучшения
1         | IdleState                    | Базовое состояние
```

## 🧠 **FSM** + **SurvivalSystem** + **TaskManager** + **AI**

- **FSM** управляет поведением с системой приоритетов
- **SurvivalSystem** работает фоново, мониторит жизненно важные показатели
- **TaskManager** управляет стеком задач с приоритетами
- **AI** работает в `IDLE` или интерпретирует сложные команды игрока

## 🔄 Механизм работы состояний

### Правила переходов и прерываний:

1. **FollowState (9)**:
   - Не прерывается критическими задачами
   - Защита + следование одновременно
   - Только уведомления в чат при критических ситуациях

2. **MineState/FarmState/BuildState (7)**:
   - Прерываются критическими задачами (8)
   - Используют freeze/resume для сохранения контекста
   - Автоматический переход в CombatState при угрозе

3. **CombatState (6)**:
   - Не вызывается из FollowState (защита встроена)
   - Возврат в предыдущее состояние через стек

4. **IdleState (1)**:
   - Обрабатывает стек задач по приоритетам
   - AI принимает решения о новых задачах

## 📜 Поведенческие состояния

- **IDLE (1)** - ожидание + обработка стека задач + AI решения
- **FOLLOW (9)** - неприкосновенное следование + защита без смены состояния
- **COMBAT (6)** - автоматическая защита с возвратом в предыдущее состояние
- **FARM (7)** - фармерство с возможностью прерывания критическими задачами
- **MINE (7)** - добыча ресурсов с pause/resume механизмом
- **BUILD (7)** - строительство с сохранением прогресса при прерывании

## 🛡️ SurvivalSystem (фоновая система)

- **Мониторинг**: здоровье, голод, прочность предметов, состояние брони
- **Не управляет ботом напрямую** - добавляет задачи в стек
- **Аналогия**: работает как сердцебиение - фоново, не мешая основной деятельности
- **Критические задачи**: здоровье < 3 сердец, отсутствие еды при голоде
- **Высокие задачи**: починка брони, пополнение ресурсов

## 🔧 Система pause/resume

```javascript
// BaseState методы
freeze(bot) {
  // Остановка таймеров и действий
  // Сохранение контекста (координаты, цели, прогресс)
}

resume(bot) {
  // Проверка валидности сохранённых данных
  // Возобновление или поиск альтернатив
}
```

## 📝 Логирование

- Используется `winston`
- Уровни: `info`, `debug`, `error`
- Новые события: `state:paused`, `state:resumed`, `survival:alert`, `task:critical`
- Каждая задача помечается correlation ID
- Поддержка вывода в stdout и файл

## 🎮 Коммуникация с игроком

- **Критические ситуации в FollowState**: "Я вот-вот умру!", "Нужна починка!"
- **Потеря целей при resume**: "Потерял алмаз", "Не могу найти материалы"
- **Завершение задач**: отчеты о выполнении
- **Перегрузка стека задач**: "Слишком много проблем, помоги!"

## ✅ Тестирование

- Unit: тесты приоритетов, freeze/resume механизмов
- Integration: тесты SurvivalSystem и TaskManager
- E2E: проверка полного цикла с прерываниями (команда → пауза → критическая задача → возврат)
- Инструменты: jest или vitest
- Прогон тестов в CI при каждом пуше

## 🔌 Расширяемость

- Новые состояния FSM добавляются с указанием приоритета
- Команды регистрируются как плагины с приоритетом 10
- Модификации состояний через декораторы (guard, stealth)
- Новые типы критических задач в SurvivalSystem

## 🔒 Безопасность

1. Белый список разрешенных действий по приоритетам
2. FollowState защищён от прерываний (кроме команд игрока)
3. Ограничение времени выполнения задач с автоматическим resume
4. Валидация AI команд через JSON Schema (приоритет 10)
5. Fallback к IdleState при критических ошибках
6. Rate limiting на команды и критические задачи

## 📚 Документация и запуск

### Локальный запуск

```bash
npm install
npm run dev
```

### Настройка окружения

- Все переменные находятся в `.env` (пример: `config/.env.example`).

**Примеры команд (приоритет 10)**

- `:follow <player>` — неприкосновенное следование (приоритет 9)
- `:stop` — остановить все действия
- `:farm` — фармерство с возможностью прерывания (приоритет 7)
- `:mine <resource>` — добыча с pause/resume (приоритет 7)
- `:build <plan>` — строительство с сохранением прогресса (приоритет 7)
- `:combat` — ручной режим охраны (приоритет 6)
- `:help` — список команд с приоритетами

## 🛣 Roadmap

1. **AI интеграция** - интерпретация сложных команд ("Беги за мной, по пути стриги овец")
2. **Модификации состояний** - guard, stealth, efficiency модификации
3. **Веб-интерфейс** для мониторинга приоритетов и состояний
4. **Интеграция с Discord** для удалённого управления
5. **Поддержка нескольких ботов** с координацией приоритетов
